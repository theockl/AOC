<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatportal</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; }
        .container { width: 80%; max-width: 600px; margin-top: 20px; }
        .hidden { display: none; }
        .chat-box { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
        .chat-box p { margin: 5px 0; }
        .admin-controls { margin-top: 20px; background-color: #f0f0f0; padding: 10px; }
        .admin-controls h3 { margin-top: 0; }
        .online-status { font-size: 14px; margin-top: 10px; }
        .online-list { margin-top: 10px; }
        .online-list p { font-size: 14px; }
    </style>
</head>
<body>

    <!-- Startseite -->
    <div id="welcome-page" class="container">
        <h2>Hallo bei All Open Chat 1.0</h2>
        <p>Bitte Passwort eingeben:</p>
        <input type="password" id="password" placeholder="Passwort">
        <button onclick="login()">Einloggen</button>
    </div>

    <!-- Benutzername-Seite -->
    <div id="username-page" class="container hidden">
        <h2>Zugeteilter Benutzername</h2>
        <p>Dein Benutzername ist: <span id="assigned-username"></span></p>
        <button onclick="confirmUsername()">Bestätigen</button>
    </div>

    <!-- Chat-Seite -->
    <div id="chat-page" class="container hidden">
        <h2>AOC Chatbereich</h2>
        <div class="online-status" id="online-status">Online: 0 Benutzer</div>
        <div class="chat-box" id="chat-box"></div>
        <input type="text" id="message" placeholder="Nachricht eingeben">
        <button onclick="sendMessage()">Senden</button>
    </div>

    <!-- Admin-Seite -->
    <div id="admin-page" class="container hidden">
        <h2>AOC Administrator</h2>
        <div class="chat-box" id="admin-chat-box"></div>
        <div class="online-list">
            <h3>Online-Benutzer:</h3>
            <div id="admin-online-users"></div> <!-- Liste der Online-Benutzer -->
        </div>
        <div class="admin-controls">
            <h3>Verwaltungsfunktionen</h3>
            <button onclick="resetChat()">Chat zurücksetzen</button>
        </div>
    </div>

    <script>
        // Globale Variablen
        let username = localStorage.getItem("username") || "";
        const bannedUsers = new Set();
        const messages = JSON.parse(localStorage.getItem("chatMessages")) || [];  // Chat dauerhaft speichern
        let isAdmin = false;
        let onlineUsers = new Set();  // Track online users

        // Einloggen
        function login() {
            const password = document.getElementById("password").value;
            if (password === "0815") {
                isAdmin = true;
                document.getElementById("welcome-page").classList.add("hidden");
                document.getElementById("admin-page").classList.remove("hidden");
                loadAdminChat();
                updateOnlineUsersList();  // Admin: Online-Benutzerliste aktualisieren
            } else if (password === "007" && !username) {
                document.getElementById("welcome-page").classList.add("hidden");
                document.getElementById("username-page").classList.remove("hidden");
                assignUsername();
            } else if (username) {
                document.getElementById("welcome-page").classList.add("hidden");
                document.getElementById("chat-page").classList.remove("hidden");
                loadChat();
            } else {
                alert("Falsches Passwort oder keine Berechtigung!");
            }
        }

        // Benutzername zuweisen
        function assignUsername() {
            if (!username) {
                username = `User${Math.floor(Math.random() * 10000)}`;
                localStorage.setItem("username", username);
            }
            document.getElementById("assigned-username").innerText = username;
        }

        // Benutzername bestätigen
        function confirmUsername() {
            document.getElementById("username-page").classList.add("hidden");
            document.getElementById("chat-page").classList.remove("hidden");
            loadChat();
        }

        // Nachricht senden
        function sendMessage() {
            const message = document.getElementById("message").value;
            if (message.trim() && !bannedUsers.has(username)) {
                messages.push({ user: username, text: message });
                localStorage.setItem("chatMessages", JSON.stringify(messages));  // Chat speichern
                updateChatBox();
                document.getElementById("message").value = "";
            }
        }

        // Chatfenster aktualisieren
        function updateChatBox() {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const messageElement = document.createElement("p");
                messageElement.textContent = `${msg.user}: ${msg.text}`;
                chatBox.appendChild(messageElement);
            });
        }

        // Admin-Chat laden und aktualisieren
        function loadAdminChat() {
            const adminChatBox = document.getElementById("admin-chat-box");
            adminChatBox.innerHTML = "";
            messages.forEach((msg, index) => {
                const messageElement = document.createElement("p");
                messageElement.innerHTML = `${msg.user}: ${msg.text} 
                <button onclick="deleteMessage(${index})">Löschen</button>`;
                adminChatBox.appendChild(messageElement);
            });
        }

        // Nachricht löschen (Admin)
        function deleteMessage(index) {
            messages.splice(index, 1);
            localStorage.setItem("chatMessages", JSON.stringify(messages));  // Chat speichern
            loadAdminChat();
            updateChatBox();
        }

        // Chat zurücksetzen (Admin)
        function resetChat() {
            if (confirm("Möchten Sie wirklich den gesamten Chat löschen?")) {
                messages.length = 0;
                localStorage.setItem("chatMessages", JSON.stringify(messages));  // Chat zurücksetzen
                loadAdminChat();
                updateChatBox();
            }
        }

        // Online-Benutzer anzeigen
        function updateOnlineUsersList() {
            const onlineUsersList = document.getElementById("admin-online-users");
            onlineUsersList.innerHTML = "";
            onlineUsers.forEach(user => {
                const userElement = document.createElement("p");
                userElement.textContent = user;
                onlineUsersList.appendChild(userElement);
            });
        }

        // Track online users when they join and leave
        function updateOnlineStatus() {
            document.getElementById("online-status").innerText = `Online: ${onlineUsers.size}`;
        }

        // Track online status across sessions
        window.addEventListener("load", () => {
            onlineUsers.add(username);  // Add the current user to the online users set
            updateOnlineStatus();
            loadChat();  // Load the chat immediately when the page loads
            if (isAdmin) {
                updateOnlineUsersList();  // Admin: Liste der Online-Benutzer aktualisieren
            }
        });

        // Simulate online/offline status and handle the event when the user leaves
        window.addEventListener("beforeunload", () => {
            onlineUsers.delete(username);  // Remove the user from the online users set when they leave
            updateOnlineStatus();
            if (isAdmin) {
                updateOnlineUsersList();  // Admin: Online-Benutzerliste aktualisieren
            }
        });

        // Initial chat load
        function loadChat() {
            updateChatBox();  // Update the chat window with all saved messages
        }
    </script>

</body>
</html>